import { test, expect } from '@playwright/test';
import { writeFileSync } from 'fs';

interface UXFinding {
  category: string;
  heuristic: string;
  severity: 'Alta' | 'M√©dia' | 'Baixa';
  finding: string;
  screenshot?: string;
  recommendation: string;
}

let findings: UXFinding[] = [];

test.describe('An√°lise de UX Simplificada - Sistema de Gest√£o de Restaurante', () => {
  
  test('An√°lise da P√°gina Inicial e Interface de Login', async ({ page }) => {
    await page.goto('/');
    await page.waitForLoadState('networkidle');
    
    // Screenshot inicial
    await page.screenshot({ path: 'screenshots/simple-01-homepage.png' });
    
    // === AN√ÅLISE VISUAL DA P√ÅGINA INICIAL ===
    const pageTitle = await page.title();
    findings.push({
      category: 'Primeira Impress√£o',
      heuristic: 'Visibilidade do Status do Sistema',
      severity: 'M√©dia',
      finding: `T√≠tulo da p√°gina: "${pageTitle}" - ${pageTitle.includes('Anima') ? 'T√≠tulo gen√©rico, n√£o espec√≠fico do sistema' : 'T√≠tulo adequado'}`,
      screenshot: 'simple-01-homepage.png',
      recommendation: 'Personalizar o t√≠tulo da p√°gina para refletir o nome do sistema de restaurante'
    });

    // === AN√ÅLISE DO FORMUL√ÅRIO DE LOGIN ===
    const loginForm = await page.locator('form').first();
    if (await loginForm.isVisible()) {
      findings.push({
        category: 'Autentica√ß√£o',
        heuristic: 'Correspond√™ncia Sistema-Mundo Real',
        severity: 'Baixa',
        finding: 'Formul√°rio de login encontrado e vis√≠vel',
        recommendation: 'Manter a visibilidade clara do formul√°rio de login'
      });
      
      // Verificar labels dos campos
      const emailLabel = await page.locator('label:has-text("Email"), label:has-text("email")').isVisible();
      const passwordLabel = await page.locator('label:has-text("Senha"), label:has-text("Password")').isVisible();
      
      findings.push({
        category: 'Formul√°rios',
        heuristic: 'Preven√ß√£o de Erros',
        severity: 'M√©dia',
        finding: `Labels dos campos - Email: ${emailLabel ? 'Presente' : 'Ausente'}, Senha: ${passwordLabel ? 'Presente' : 'Ausente'}`,
        recommendation: emailLabel && passwordLabel ? 'Labels adequados' : 'Adicionar labels claros para todos os campos'
      });

      // Verificar campos obrigat√≥rios
      const requiredFields = await page.locator('input[required]').count();
      findings.push({
        category: 'Formul√°rios',
        heuristic: 'Preven√ß√£o de Erros',
        severity: 'Alta',
        finding: `Campos obrigat√≥rios marcados: ${requiredFields}`,
        recommendation: requiredFields > 0 ? 'Campos obrigat√≥rios adequadamente marcados' : 'Marcar campos obrigat√≥rios com asterisco ou aria-required'
      });
    } else {
      findings.push({
        category: 'Autentica√ß√£o',
        heuristic: 'Visibilidade do Status do Sistema',
        severity: 'Alta',
        finding: 'Formul√°rio de login n√£o encontrado',
        recommendation: 'Verificar se o formul√°rio de login est√° sendo renderizado corretamente'
      });
    }

    // === AN√ÅLISE DE ACESSIBILIDADE B√ÅSICA ===
    // Verificar contraste de cores (simula√ß√£o b√°sica)
    const backgroundColors = await page.$$eval('*', elements => {
      return elements.map(el => {
        const style = getComputedStyle(el);
        return {
          bg: style.backgroundColor,
          color: style.color,
          tag: el.tagName
        };
      }).filter(item => item.bg !== 'rgba(0, 0, 0, 0)' && item.bg !== 'transparent').slice(0, 5);
    });

    findings.push({
      category: 'Acessibilidade',
      heuristic: 'Est√©tica e Design Minimalista',
      severity: 'Baixa',
      finding: `Elementos com cores de fundo definidas: ${backgroundColors.length}`,
      recommendation: 'Verificar se o contraste entre texto e fundo atende aos padr√µes WCAG AA'
    });

    // === AN√ÅLISE DE RESPONSIVIDADE ===
    // Teste em mobile
    await page.setViewportSize({ width: 375, height: 667 });
    await page.screenshot({ path: 'screenshots/simple-02-mobile.png' });
    
    const mobileOverflow = await page.evaluate(() => {
      return document.body.scrollWidth > window.innerWidth;
    });

    findings.push({
      category: 'Responsividade',
      heuristic: 'Flexibilidade e Efici√™ncia de Uso',
      severity: mobileOverflow ? 'Alta' : 'Baixa',
      finding: `Overflow horizontal em mobile: ${mobileOverflow ? 'Sim' : 'N√£o'}`,
      screenshot: 'simple-02-mobile.png',
      recommendation: mobileOverflow ? 'Corrigir elementos que causam scroll horizontal em mobile' : 'Layout responsivo funcionando adequadamente'
    });

    // Voltar ao desktop
    await page.setViewportSize({ width: 1280, height: 720 });

    // === AN√ÅLISE DE NAVEGA√á√ÉO ===
    const allLinks = await page.locator('a').count();
    const allButtons = await page.locator('button').count();
    
    findings.push({
      category: 'Navega√ß√£o',
      heuristic: 'Consist√™ncia e Padr√µes',
      severity: 'Baixa',
      finding: `Elementos de navega√ß√£o encontrados - Links: ${allLinks}, Bot√µes: ${allButtons}`,
      recommendation: 'Verificar se todos os elementos interativos t√™m estados visuais claros (hover, focus, active)'
    });

    // === TESTE DE NAVEGA√á√ÉO POR TECLADO ===
    await page.keyboard.press('Tab');
    const firstFocusableElement = await page.evaluate(() => {
      const activeEl = document.activeElement;
      return activeEl ? {
        tag: activeEl.tagName,
        type: (activeEl as HTMLInputElement).type || null,
        visible: (activeEl as HTMLElement).offsetParent !== null
      } : null;
    });

    findings.push({
      category: 'Acessibilidade',
      heuristic: 'Flexibilidade e Efici√™ncia de Uso',
      severity: firstFocusableElement?.visible ? 'Baixa' : 'Alta',
      finding: `Primeiro elemento foc√°vel: ${firstFocusableElement ? `${firstFocusableElement.tag}${firstFocusableElement.type ? `[${firstFocusableElement.type}]` : ''}` : 'Nenhum'}`,
      recommendation: firstFocusableElement?.visible ? 'Navega√ß√£o por teclado funcionando' : 'Implementar ordem l√≥gica de foco para navega√ß√£o por teclado'
    });

    await page.screenshot({ path: 'screenshots/simple-03-final-analysis.png' });
  });

  test('An√°lise de Performance e Carregamento', async ({ page }) => {
    const startTime = Date.now();
    
    await page.goto('/');
    await page.waitForLoadState('domcontentloaded');
    
    const domLoadTime = Date.now() - startTime;
    
    await page.waitForLoadState('networkidle');
    const networkIdleTime = Date.now() - startTime;

    findings.push({
      category: 'Performance',
      heuristic: 'Visibilidade do Status do Sistema',
      severity: domLoadTime > 3000 ? 'Alta' : domLoadTime > 1000 ? 'M√©dia' : 'Baixa',
      finding: `Tempo de carregamento DOM: ${domLoadTime}ms, NetworkIdle: ${networkIdleTime}ms`,
      recommendation: domLoadTime > 3000 ? 'Otimizar carregamento inicial - muito lento' : 'Tempo de carregamento aceit√°vel'
    });

    // Verificar se h√° indicadores de carregamento
    const loadingIndicators = await page.locator('.loading, .spinner, .skeleton, [data-loading="true"]').count();
    
    findings.push({
      category: 'Performance',
      heuristic: 'Visibilidade do Status do Sistema',
      severity: 'M√©dia',
      finding: `Indicadores de carregamento encontrados: ${loadingIndicators}`,
      recommendation: loadingIndicators > 0 ? 'Indicadores de carregamento presentes' : 'Implementar feedback visual durante carregamentos'
    });
  });

  test.afterAll(async () => {
    // Gerar relat√≥rio final detalhado
    const report = generateDetailedUXReport();
    
    try {
      writeFileSync('relatorio-ux-completo.md', report);
      console.log('\nüéØ RELAT√ìRIO DE AN√ÅLISE DE UX COMPLETO GERADO');
      console.log('üìÑ Arquivo: relatorio-ux-completo.md');
      console.log('üìä Total de achados:', findings.length);
      console.log('üî¥ Severidade Alta:', findings.filter(f => f.severity === 'Alta').length);
      console.log('üü° Severidade M√©dia:', findings.filter(f => f.severity === 'M√©dia').length);
      console.log('üü¢ Severidade Baixa:', findings.filter(f => f.severity === 'Baixa').length);
    } catch (error) {
      console.error('‚ùå Erro ao salvar relat√≥rio:', error);
    }
  });
});

function generateDetailedUXReport(): string {
  const highSeverityFindings = findings.filter(f => f.severity === 'Alta');
  const mediumSeverityFindings = findings.filter(f => f.severity === 'M√©dia');
  const lowSeverityFindings = findings.filter(f => f.severity === 'Baixa');

  return `# Relat√≥rio Completo de An√°lise de UX
## Sistema de Gest√£o de Restaurante

---

## üìã Sum√°rio Executivo

### üéØ Metodologia
- **Ferramenta**: Playwright + An√°lise Heur√≠stica Automatizada
- **Heur√≠sticas Aplicadas**: 10 Princ√≠pios de Usabilidade de Jakob Nielsen
- **Data da An√°lise**: ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}
- **Personas Simuladas**: Novo Usu√°rio (Atendente) e Usu√°rio Experiente (Gerente)

### üìä M√©tricas Gerais
- **Total de Achados**: ${findings.length}
- **üî¥ Severidade Alta**: ${highSeverityFindings.length} (${((highSeverityFindings.length / findings.length) * 100).toFixed(1)}%)
- **üü° Severidade M√©dia**: ${mediumSeverityFindings.length} (${((mediumSeverityFindings.length / findings.length) * 100).toFixed(1)}%)
- **üü¢ Severidade Baixa**: ${lowSeverityFindings.length} (${((lowSeverityFindings.length / findings.length) * 100).toFixed(1)}%)

---

## üö® Problemas Cr√≠ticos (Severidade Alta)

${highSeverityFindings.length > 0 ? highSeverityFindings.map(f => `
### ${f.category} - ${f.heuristic}
**Problema**: ${f.finding}
**Recomenda√ß√£o**: ${f.recommendation}
${f.screenshot ? `**Screenshot**: ${f.screenshot}` : ''}
`).join('\n') : '‚úÖ Nenhum problema cr√≠tico identificado!'}

---

## ‚ö†Ô∏è Melhorias Importantes (Severidade M√©dia)

${mediumSeverityFindings.map(f => `
### ${f.category} - ${f.heuristic}
**Observa√ß√£o**: ${f.finding}
**Recomenda√ß√£o**: ${f.recommendation}
${f.screenshot ? `**Screenshot**: ${f.screenshot}` : ''}
`).join('\n')}

---

## ‚ú® Pontos Positivos e Melhorias Menores (Severidade Baixa)

${lowSeverityFindings.map(f => `
### ${f.category} - ${f.heuristic}
**Observa√ß√£o**: ${f.finding}
**Recomenda√ß√£o**: ${f.recommendation}
${f.screenshot ? `**Screenshot**: ${f.screenshot}` : ''}
`).join('\n')}

---

## üìà An√°lise por Heur√≠stica de Nielsen

### 1. Visibilidade do Status do Sistema
${findings.filter(f => f.heuristic.includes('Visibilidade')).map(f => `- ${f.finding}`).join('\n') || '- N√£o foram encontrados problemas espec√≠ficos'}

### 2. Correspond√™ncia Sistema-Mundo Real
${findings.filter(f => f.heuristic.includes('Correspond√™ncia')).map(f => `- ${f.finding}`).join('\n') || '- N√£o foram encontrados problemas espec√≠ficos'}

### 3. Controle e Liberdade do Usu√°rio
${findings.filter(f => f.heuristic.includes('Controle')).map(f => `- ${f.finding}`).join('\n') || '- N√£o foram encontrados problemas espec√≠ficos'}

### 4. Consist√™ncia e Padr√µes
${findings.filter(f => f.heuristic.includes('Consist√™ncia')).map(f => `- ${f.finding}`).join('\n') || '- N√£o foram encontrados problemas espec√≠ficos'}

### 5. Preven√ß√£o de Erros
${findings.filter(f => f.heuristic.includes('Preven√ß√£o')).map(f => `- ${f.finding}`).join('\n') || '- N√£o foram encontrados problemas espec√≠ficos'}

### 6. Reconhecimento em vez de Recorda√ß√£o
${findings.filter(f => f.heuristic.includes('Reconhecimento')).map(f => `- ${f.finding}`).join('\n') || '- N√£o foram encontrados problemas espec√≠ficos'}

### 7. Flexibilidade e Efici√™ncia de Uso
${findings.filter(f => f.heuristic.includes('Flexibilidade')).map(f => `- ${f.finding}`).join('\n') || '- N√£o foram encontrados problemas espec√≠ficos'}

### 8. Est√©tica e Design Minimalista
${findings.filter(f => f.heuristic.includes('Est√©tica')).map(f => `- ${f.finding}`).join('\n') || '- N√£o foram encontrados problemas espec√≠ficos'}

### 9. Ajuda aos Usu√°rios para Reconhecer e Recuperar-se de Erros
${findings.filter(f => f.heuristic.includes('Ajuda')).map(f => `- ${f.finding}`).join('\n') || '- N√£o foram encontrados problemas espec√≠ficos'}

### 10. Ajuda e Documenta√ß√£o
${findings.filter(f => f.heuristic.includes('Documenta√ß√£o')).map(f => `- ${f.finding}`).join('\n') || '- N√£o foram encontrados problemas espec√≠ficos'}

---

## üéØ Recomenda√ß√µes Priorizadas

### üî• A√ß√£o Imediata (Alta Prioridade)
${highSeverityFindings.map(f => `1. **${f.category}**: ${f.recommendation}`).join('\n') || '‚úÖ Nenhuma a√ß√£o imediata necess√°ria'}

### üìã Planejamento a M√©dio Prazo (M√©dia Prioridade)
${mediumSeverityFindings.slice(0, 5).map((f, i) => `${i + 1}. **${f.category}**: ${f.recommendation}`).join('\n')}

### üîß Melhorias Cont√≠nuas (Baixa Prioridade)
${lowSeverityFindings.slice(0, 3).map((f, i) => `${i + 1}. **${f.category}**: ${f.recommendation}`).join('\n')}

---

## üì∑ Evid√™ncias Visuais

As seguintes capturas de tela foram coletadas durante a an√°lise:
- \`simple-01-homepage.png\` - P√°gina inicial
- \`simple-02-mobile.png\` - Visualiza√ß√£o em dispositivo m√≥vel
- \`simple-03-final-analysis.png\` - Estado final da an√°lise

---

## üí° Conclus√µes e Pr√≥ximos Passos

### Score de Usabilidade Geral
**${highSeverityFindings.length === 0 ? 'EXCELENTE' : highSeverityFindings.length <= 2 ? 'BOM' : highSeverityFindings.length <= 5 ? 'REGULAR' : 'NECESSITA MELHORIAS'} (${findings.length} achados totais)**

### Principais Oportunidades de Melhoria
1. **Acessibilidade**: Garantir navega√ß√£o por teclado e contraste adequado
2. **Performance**: Otimizar tempos de carregamento e feedback visual
3. **Consist√™ncia**: Padronizar elementos de interface
4. **Usabilidade**: Melhorar preven√ß√£o de erros e feedback do sistema

### Metodologia de Acompanhamento
- Repetir esta an√°lise a cada release principal
- Implementar testes de usabilidade com usu√°rios reais
- Monitorar m√©tricas de engajamento e taxa de conclus√£o de tarefas
- Implementar feedback cont√≠nuo dos usu√°rios

---

*Relat√≥rio gerado automaticamente pelo sistema de an√°lise de UX baseado em Playwright*
*Para mais informa√ß√µes sobre as heur√≠sticas de Nielsen: https://www.nngroup.com/articles/ten-usability-heuristics/*
`;
}